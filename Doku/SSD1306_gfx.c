/*
 * SSD1306_gfx.c
 *
 *  Created on: May 6, 2019
 *      Author: Besitzer
 */


/***********************************************************************
* Includes
***********************************************************************/
#include "SSD1306.h"
#include "math.h"
#include <stdio.h>
#include <stdlib.h>
/***********************************************************************
* Informations
***********************************************************************/
//https://www.nxp.com/files-static/sensors/doc/data_sheet/MMA7260QT.pdf
//https://www.mikrocontroller.net/topic/415651
/***********************************************************************
* Global Variable
***********************************************************************/

/***********************************************************************
* Local Funtions
***********************************************************************/
void SSD1306_DrawEllipse_base(uint8_t center_x, uint8_t center_y, uint8_t radius_x, uint8_t radius_y);
/***********************************************************************
* Local Variable
***********************************************************************/

 /* buffer for the display + 1 Byte for Command*/
/***********************************************************************
* Constant
***********************************************************************/
/** tiny 5x8 font. */
static unsigned char font[] = {
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,    // [0x20] ' '
    0x0,  0x0,  0x2F, 0x0,  0x0,  0x0,    // [0x21] '!'
    0x0,  0x3,  0x0,  0x3,  0x0,  0x0,    // [0x22] '"'
    0x14, 0x3E, 0x14, 0x3E, 0x14, 0x0,    // [0x23] '#'
    0x24, 0x2A, 0x7F, 0x2A, 0x12, 0x0,    // [0x24] '$'
    0x22, 0x10, 0x8,  0x4,  0x22, 0x0,    // [0x25] '%'
    0x18, 0x24, 0x24, 0x1E, 0x4,  0x0,    // [0x26] '&'
    0x0,  0x0,  0x3,  0x0,  0x0,  0x0,    // [0x27] '''
    0x0,  0x1C, 0x22, 0x41, 0x0,  0x0,    // [0x28] '('
    0x0,  0x41, 0x22, 0x1C, 0x0,  0x0,    // [0x29] ')'
    0x2A, 0x1C, 0x3E, 0x1C, 0x2A, 0x0,    // [0x2A] '*'
    0x8,  0x8,  0x3E, 0x8,  0x8,  0x0,    // [0x2B] '+'
    0x0,  0x40, 0x20, 0x0,  0x0,  0x0,    // [0x2C] ','
    0x8,  0x8,  0x8,  0x8,  0x8,  0x0,    // [0x2D] '-'
    0x0,  0x0,  0x20, 0x0,  0x0,  0x0,    // [0x2E] '.'
    0x0,  0xC0, 0x30, 0xC,  0x3,  0x0,    // [0x2F] '/'
    0x1E, 0x29, 0x2D, 0x25, 0x1E, 0x0,    // [0x30] '0'
    0x0,  0x22, 0x3F, 0x20, 0x0,  0x0,    // [0x31] '1'
    0x32, 0x29, 0x29, 0x29, 0x26, 0x0,    // [0x32] '2'
    0x12, 0x21, 0x29, 0x29, 0x16, 0x0,    // [0x33] '3'
    0x7,  0x8,  0x8,  0x8,  0x3E, 0x0,    // [0x34] '4'
    0x17, 0x25, 0x25, 0x25, 0x18, 0x0,    // [0x35] '5'
    0x1E, 0x25, 0x25, 0x25, 0x18, 0x0,    // [0x36] '6'
    0x1,  0x1,  0x9,  0x9,  0x3E, 0x0,    // [0x37] '7'
    0x1A, 0x25, 0x25, 0x25, 0x1A, 0x0,    // [0x38] '8'
    0x6,  0x9,  0x9,  0x9,  0x3E, 0x0,    // [0x39] '9'
    0x0,  0x0,  0x22, 0x0,  0x0,  0x0,    // [0x3A] ':'
    0x0,  0x40, 0x22, 0x0,  0x0,  0x0,    // [0x3B] ';'
    0x0,  0x8,  0x14, 0x22, 0x41, 0x0,    // [0x3C] '<'
    0x14, 0x14, 0x14, 0x14, 0x14, 0x0,    // [0x3D] '='
    0x0,  0x41, 0x22, 0x14, 0x8,  0x0,    // [0x3E] '>'
    0x2,  0x1,  0x29, 0x9,  0x6,  0x0,    // [0x3F] '?'
    0x1E, 0x21, 0x2D, 0x2D, 0x6,  0x0,    // [0x40] '@'
    0x3E, 0x11, 0x11, 0x11, 0x3E, 0x0,    // [0x41] 'A'
    0x3E, 0x25, 0x25, 0x25, 0x1A, 0x0,    // [0x42] 'B'
    0x1E, 0x21, 0x21, 0x21, 0x12, 0x0,    // [0x43] 'C'
    0x3E, 0x21, 0x21, 0x22, 0x1C, 0x0,    // [0x44] 'D'
    0x3F, 0x29, 0x29, 0x21, 0x21, 0x0,    // [0x45] 'E'
    0x3F, 0x9,  0x9,  0x1,  0x1,  0x0,    // [0x46] 'F'
    0x1E, 0x21, 0x29, 0x29, 0x1A, 0x0,    // [0x47] 'G'
    0x3F, 0x8,  0x8,  0x8,  0x3F, 0x0,    // [0x48] 'H'
    0x0,  0x21, 0x3F, 0x21, 0x0,  0x0,    // [0x49] 'I'
    0x10, 0x20, 0x21, 0x21, 0x1F, 0x0,    // [0x4A] 'J'
    0x3F, 0x8,  0xC,  0x12, 0x21, 0x0,    // [0x4B] 'K'
    0x1F, 0x20, 0x20, 0x20, 0x20, 0x0,    // [0x4C] 'L'
    0x3E, 0x1,  0x6,  0x1,  0x3E, 0x0,    // [0x4D] 'M'
    0x3E, 0x1,  0x1,  0x2,  0x3C, 0x0,    // [0x4E] 'N'
    0x1E, 0x21, 0x21, 0x21, 0x1E, 0x0,    // [0x4F] 'O'
    0x3E, 0x11, 0x11, 0x11, 0xE,  0x0,    // [0x50] 'P'
    0x1E, 0x21, 0x29, 0x71, 0x5E, 0x0,    // [0x51] 'Q'
    0x3E, 0x9,  0x9,  0x9,  0x36, 0x0,    // [0x52] 'R'
    0x12, 0x25, 0x25, 0x25, 0x18, 0x0,    // [0x53] 'S'
    0x1,  0x1,  0x3F, 0x1,  0x1,  0x0,    // [0x54] 'T'
    0x1F, 0x20, 0x20, 0x20, 0x1F, 0x0,    // [0x55] 'U'
    0xF,  0x10, 0x20, 0x10, 0xF,  0x0,    // [0x56] 'V'
    0x1F, 0x20, 0x18, 0x20, 0x1F, 0x0,    // [0x57] 'W'
    0x31, 0xA,  0x4,  0xA,  0x31, 0x0,    // [0x58] 'X'
    0x7,  0x28, 0x28, 0x28, 0x1F, 0x0,    // [0x59] 'Y'
    0x31, 0x29, 0x25, 0x23, 0x21, 0x0,    // [0x5A] 'Z'
    0x0,  0x7F, 0x41, 0x41, 0x0,  0x0,    // [0x5B] '['
    0x0,  0x3,  0xC,  0x30, 0xC0, 0x0,    // [0x5C] '\\'
    0x0,  0x41, 0x41, 0x7F, 0x0,  0x0,    // [0x5D] ']'
    0x0,  0x2,  0x1,  0x2,  0x0,  0x0,    // [0x5E] '^'
    0x40, 0x40, 0x40, 0x40, 0x40, 0x0,    // [0x5F] '_'
    0x1,  0x2,  0x0,  0x0,  0x0,  0x0,    // [0x60] '`'
    0x1C, 0x22, 0x22, 0x22, 0x3C, 0x0,    // [0x61] 'a'
    0x1F, 0x22, 0x22, 0x22, 0x1C, 0x0,    // [0x62] 'b'
    0x1C, 0x22, 0x22, 0x22, 0x20, 0x0,    // [0x63] 'c'
    0x1C, 0x22, 0x22, 0x22, 0x1F, 0x0,    // [0x64] 'd'
    0x1C, 0x2A, 0x2A, 0x2A, 0x4,  0x0,    // [0x65] 'e'
    0x8,  0x7E, 0x9,  0x1,  0x1,  0x0,    // [0x66] 'f'
    0xC,  0x52, 0x52, 0x52, 0x3C, 0x0,   // [0x67] 'g'
    0x3F, 0x2,  0x2,  0x2,  0x3C, 0x0,    // [0x68] 'h'
    0x0,  0x0,  0x3D, 0x0,  0x0,  0x0,    // [0x69] 'i'
    0x20, 0x40, 0x40, 0x40, 0x3D, 0x0,    // [0x6A] 'j'
    0x3F, 0x8,  0x8,  0x14, 0x22, 0x0,    // [0x6B] 'k'
    0x0,  0x1F, 0x20, 0x20, 0x0,  0x0,    // [0x6C] 'l'
    0x3C, 0x2,  0x4,  0x2,  0x3C, 0x0,    // [0x6D] 'm'
    0x3C, 0x2,  0x2,  0x2,  0x3C, 0x0,    // [0x6E] 'n'
    0x1C, 0x22, 0x22, 0x22, 0x1C, 0x0,    // [0x6F] 'o'
    0x7C, 0x12, 0x12, 0x12, 0xC,  0x0,    // [0x70] 'p'
    0xC,  0x12, 0x12, 0x12, 0x7E, 0x0,    // [0x71] 'q'
    0x3C, 0x2,  0x2,  0x2,  0x4,  0x0,    // [0x72] 'r'
    0x24, 0x2A, 0x2A, 0x2A, 0x10, 0x0,    // [0x73] 's'
    0x1F, 0x22, 0x22, 0x20, 0x10, 0x0,    // [0x74] 't'
    0x1E, 0x20, 0x20, 0x20, 0x1E, 0x0,    // [0x75] 'u'
    0xE,  0x10, 0x20, 0x10, 0xE,  0x0,    // [0x76] 'v'
    0x1E, 0x20, 0x10, 0x20, 0x1E, 0x0,    // [0x77] 'w'
    0x22, 0x14, 0x8,  0x14, 0x22, 0x0,    // [0x78] 'x'
    0xE,  0x50, 0x50, 0x50, 0x3E, 0x0,    // [0x79] 'y'
    0x22, 0x32, 0x2A, 0x26, 0x22, 0x0,    // [0x7A] 'z'
    0x0,  0x8,  0x36, 0x41, 0x0,  0x0,    // [0x7B] '{'
    0x0,  0x0,  0x7F, 0x0,  0x0,  0x0,    // [0x7C] '|'
    0x0,  0x41, 0x36, 0x8,  0x0,  0x0,    // [0x7D] '}'
    0x0,  0x2,  0x1,  0x2,  0x1,  0x0,    // [0x7E] '~'
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,    // [0x7F] ''
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,    // [0x80] ''
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,    // [0x81] ''
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,    // [0x82] ''
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,    // [0x83] ''
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,    // [0x84] ''
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,    // [0x85] ''
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,    // [0x86] ''
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,    // [0x87] ''
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,    // [0x88] ''
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,    // [0x89] ''
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,    // [0x8A] ''
    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,    // [0x8B] ''
};

/***********************************************************************
*! \fn			static void SSD1306_PrintChar(uint8_t ch, uint8_t x_pos, uint8_t y_pos)
*  \brief		write an char to the display
*  \param		uint8_t ch to print
*  \param		uint8_t x_pos - position in fradius_xmebuffer
*  \param		uint8_t y_pos - position in fradius_xmebuffer
*  \ecenter_xeption	none
*  \return		none
***********************************************************************/
void SSD1306_PrintChar(uint8_t ch, uint8_t x_pos, uint8_t y_pos){
	/*uint8_t i;
	for(i = 0; i<5; i++) {
		SSD1306_WriteData(font[((ch-0x20)*6)+i]);
	}*/
	
	uint8_t bit_mask, font_index, font_index_bit;
	//loop for char width
	for(font_index = 0; font_index < 5; font_index++){
		bit_mask = 0x01;
		//loop for char height
		for(font_index_bit = 0; font_index_bit < 8; font_index_bit++){
			if(font[((ch-0x20)*6)+font_index]&bit_mask)
				//move forward 
				SSD1306_DrawDot(x_pos+font_index, y_pos+font_index_bit, 1);
			else
				SSD1306_DrawDot(x_pos+font_index, y_pos+font_index_bit, 0);
			//shift mask
			bit_mask<<=1;
		}
	}
}

/***********************************************************************
*! \fn			void SSD1306_DrawLine(uint8_t x_start, uint8_t x_end, uint8_t y_start, uint8_t y_end)
*  \brief		dradius_xw a line from x/y start to x/y end
*  \param		uint8_t x_start
*  \param		uint8_t x_end
*  \param		uint8_t y_start
*  \param		uint8_t y_end
*  \ecenter_xeption	none
*  \return		none
***********************************************************************/
void SSD1306_DrawLine(uint8_t x_start, uint8_t x_end, uint8_t y_start, uint8_t y_end){
	
	float delta, delta_x, delta_y;
	uint8_t swap,index;
	
	//Swap start and if possible for positive values
	if(x_end < x_start){
		swap = x_end;
		x_end = x_start;
		x_start = swap;
	}
	//calculate difference step
	delta_x = (float)x_end - (float)x_start;
	
	if(y_end < y_start){
		swap = y_end;
		y_end = y_start;
		y_start = swap;
	}
	//calculate difference step
	delta_y = (float)y_end - (float)y_start;	
	
	//find max length and swap if needed
	if(abs(x_end-x_start) >= abs(y_end-y_start)){
		//calculate rise
		delta =  delta_y/delta_x;
		//set start
		delta_y = y_start;
		for(index = x_start; index < x_end; index++){
			SSD1306_DrawDot((uint8_t)(index), (uint8_t)delta_y, 1);
			delta_y += delta;
		}
	}
	else{
		//calculate rise
		delta =  delta_x/delta_y;
		//set start
		delta_x = x_start;
		for(index = y_start; index < y_end; index++){
			SSD1306_DrawDot((uint8_t)delta_x, (uint8_t)(index), 1);
			delta_x += delta;
		}		
	}	
}

/***********************************************************************
*! \fn			void SSD1306_Dradius_xwRectangle(uint8_t x_start, uint8_t y_start, uint8_t x_end, uint8_t y_end, bool fill)
*  \brief		dradius_xw a an rectangle
*  \param		uint8_t x_start
*  \param		uint8_t y_start
*  \param		uint8_t x_end
*  \param		uint8_t y_end
*  \param		bool fill, 1 is filled
*  \ecenter_xeption	none
*  \return		none
***********************************************************************/
void SSD1306_DrawRectangle(uint8_t x_start, uint8_t y_start, uint8_t x_end, uint8_t y_end, bool fill){
	
	//dradius_xw body;
	SSD1306_DrawLine(x_start, x_start, y_start, y_end);
	SSD1306_DrawLine(x_start, x_end, y_end, y_end);
	SSD1306_DrawLine(x_start, x_end, y_start, y_start);
	SSD1306_DrawLine(x_start, x_end, y_end, y_end);
	if(fill){
		for(x_start; x_start < x_end; x_start++){
			SSD1306_DrawLine(x_start, x_start, y_start, y_end);
		}
	}
		
}

/***********************************************************************
*! \fn			void SSD1306_PrintString(uint8_t *str, uint8_t x_pos, uint8_t y_pos)
*  \brief		Simple low level method printing text to the display.
*	  	        Newline is supported.
*  \param		uint8_t *str - Pointer to string to be printed on display
*  \param		uint8_t x_pos - Start Position x
*  \param		uint8_t y_pos - Start Position y
*  \ecenter_xeption	none
*  \return		none
***********************************************************************/
void SSD1306_PrintString(uint8_t *str, uint8_t x_pos, uint8_t y_pos){
	uint8_t x = 0;
	while(*str != '\0'){
		if(*str == '\n') {
			y_pos+=8;
			if(y_pos >= SSD1306_DISPLAY_HW_NOF_PAGES) {
				y_pos=0;
			}
			//SSD1306_SetPageStartAddr(actPage);
			//SSD1306_SetColStartAddr(0);
			str++;
		} else {
			SSD1306_PrintChar(*str,x_pos,y_pos);
			str++;
			x_pos += 5;
		}
	}
}

/***********************************************************************
*! \fn			void SSD1306_DawEllipse(uint8_t center_x, uint8_t center_y, uint8_t radius_xdius_x, uint8_t radius_xdius_y, bool fill)
*  \brief		draw an ellipse
*  \param		uint8_t center_x
*  \param		uint8_t center_x
*  \param		uint8_t radius_xdius_x
*  \param		uint8_t radius_xdius_y
*  \param		bool fill
*  \ecenter_xeption	none
*  \return		none
***********************************************************************/
void SSD1306_DrawEllipse(uint8_t center_x, uint8_t center_y, uint8_t radius_x, uint8_t radius_y, bool fill){
	
	uint8_t radius;
	
	//Draw Outline
	SSD1306_DrawEllipse_base(center_x, center_y, radius_x, radius_y);
	
	if(fill){
		for(radius = radius_x; radius>0; radius--)
			SSD1306_DrawEllipse_base(center_x, center_y, (radius-1), radius_y);
		for(radius = radius_y; radius>0; radius--)
			SSD1306_DrawEllipse_base(center_x, center_y, radius_x, (radius-1));
	}
	
	
}

/***********************************************************************
*! \fn			void SSD1306_DawEllipse(uint8_t center_x, uint8_t center_y, uint8_t radius_xdius_x, uint8_t radius_xdius_y)
*  \brief		draw an ellipse
*  \param		uint8_t center_x
*  \param		uint8_t center_x
*  \param		uint8_t radius_xdius_x
*  \param		uint8_t radius_xdius_y
*  \ecenter_xeption	none
*  \return		none
***********************************************************************/
void SSD1306_DrawEllipse_base(uint8_t center_x, uint8_t center_y, uint8_t radius_x, uint8_t radius_y){
	
	int16_t x  = 0;
	int16_t y  = radius_y;
	int32_t A2 = radius_x * radius_x;
	int32_t B2 = radius_y * radius_y;
	int32_t C1 = -((A2 >> 2) + (radius_x & 0x01) + B2);
	int32_t C2 = -((B2 >> 2) + (radius_y & 0x01) + A2);
	int32_t C3 = -((B2 >> 2) + (radius_y & 0x01));
	int32_t t  = -A2 * y;
	int32_t dX = B2 * x * 2;
	int32_t dY = -A2 * y * 2;
	int32_t dXt2 = B2 * 2;
	int32_t dYt2 = A2 * 2;
	// Screen width and height for less calculations
	int16_t sh  = SSD1306_DISPLAY_HW_NOF_ROWS - 1;
	int16_t sw  = SSD1306_DISPLAY_HW_NOF_COLUMNS  - 1;

	while ((y >= 0) && (x <= radius_x)) {
		if ((center_x + x < sw) && (center_y + y < sh)) {
			SSD1306_DrawDot((uint8_t)(center_x + x),(uint8_t)(center_y + y),1);
		}
		if (x || y) {
			if ((center_x - x > -1) && (center_y - y > -1)) {
				SSD1306_DrawDot((uint8_t)(center_x - x),(uint8_t)(center_y - y),1);
			}
		}
		if (x && y) {
			if ((center_x + x < sw) && (center_y - y > - 1)) {
				SSD1306_DrawDot((uint8_t)(center_x + x),(uint8_t)(center_y - y),1);
			}
			if ((center_x - x > -1) && (center_y + y < sh)) {
				SSD1306_DrawDot((uint8_t)(center_x - x),(uint8_t)(center_y + y),1);
			}
		}

		if ((t + x*B2 <= C1) || (t + y*A2 <= C3)) {
			dX += dXt2;
			t  += dX;
			x++;
		} else if (t - y*A2 > C2) {
			dY += dYt2;
			t  += dY;
			y--;
		} else {
			dX += dXt2;
			dY += dYt2;
			t  += dX;
			t  += dY;
			x++;
			y--;
		}
	}
}
